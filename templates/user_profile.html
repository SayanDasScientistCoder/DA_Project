<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ target_user.name }} - Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .navbar-custom { background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.08); padding: 15px 0; }
    .navbar-brand { font-weight: bold; color: #007bff; font-size: 1.5rem; }
    .profile-header { background: linear-gradient(135deg, #007bff, #00d4ff); height: 200px; border-radius: 0 0 20px 20px; }
    .profile-info-card { margin-top: -100px; border: none; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
    .profile-avatar { width: 120px; height: 120px; background: #fff; padding: 5px; border-radius: 50%; margin-top: -60px; }
    .avatar-placeholder { width: 100%; height: 100%; background: #6c757d; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3rem; font-weight: bold; }
    .interest-tag { display: inline-block; background-color: #e7f3ff; color: #1877f2; padding: 6px 14px; border-radius: 20px; margin: 4px; font-size: 0.9rem; font-weight: 600; }
    .post-card { border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; }
    /* Interest Modal Specific Styles */
    .interests-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin: 20px 0; }
    .interest-box { background: #f8f9fa; border-radius: 8px; padding: 8px; cursor: pointer; text-align: center; border: 2px solid transparent; transition: 0.2s; }
    .interest-box.selected { background: #e7f1ff; color: #007bff; border-color: #007bff; }
  </style>
</head>
<body>

  <nav class="navbar-custom mb-4">
    <div class="container d-flex justify-content-between align-items-center">
        <a href="/home" class="navbar-brand text-decoration-none">KGP Connect</a>
        <div>
             <a href="/home" class="btn btn-outline-primary rounded-pill me-2">Home</a>
             <a href="/logout" class="btn btn-light rounded-pill">Logout</a>
        </div>
    </div>
  </nav>

  <div class="container">
      <div class="profile-header"></div>
  </div>

  <div class="container">
      <div class="row justify-content-center">
          <div class="col-lg-10">
              <div class="card profile-info-card p-4 mb-4">
                  <div class="d-flex flex-column align-items-center text-center">
                      <div class="profile-avatar">
                          <div class="avatar-placeholder">{{ target_user.name[0] | upper }}</div>
                      </div>
                      <h2 class="fw-bold mt-3">{{ target_user.name }}</h2>
                      <p class="text-muted mb-3">{{ target_user.department }}</p>
                      {% if target_user.bio %}<p class="mb-4" style="max-width: 600px;">{{ target_user.bio }}</p>{% endif %}

                      <div class="d-flex gap-2 mb-4">
                          {% if user.id != target_user.id %}
                            <a href="/chat/{{ target_user.id }}" class="btn btn-primary rounded-pill px-4 fw-bold">üí¨ Message</a>
                          {% else %}
                            <button class="btn btn-outline-primary rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#editProfileModal">‚úèÔ∏è Edit Profile</button>
                            <button class="btn btn-outline-secondary rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#passwordModal">üîí Password</button>
                            <button class="btn btn-outline-success rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#interestModal">üé® Interests</button>
                          {% endif %}
                      </div>
                  </div>
                  <hr>
                  <h5 class="fw-bold mt-4 mb-3">Interests</h5>
                  <div class="mb-4">
                    {% set interests = target_user.interests.split(',')|map('trim')|list if target_user.interests else [] %}
                    {% for interest in interests %}
                        {% if interest %}<span class="interest-tag">{{ interest }}</span>{% endif %}
                    {% else %}
                        <p class="text-muted fst-italic">No interests added yet.</p>
                    {% endfor %}
                  </div>
              </div>

              <h4 class="fw-bold mb-3 text-secondary">Activity</h4>
              {% for post in posts %}
              <div class="card post-card p-4">
                  <div class="d-flex justify-content-between mb-3">
                      <span class="fw-bold">{{ target_user.name }}</span>
                      <small class="text-muted">{{ post.timestamp.strftime('%d %b %Y') }}</small>
                  </div>
                  <p class="mb-0 fs-5">{{ post.content }}</p>
              </div>
              {% else %}
              <div class="card post-card p-5 text-center text-muted"><h5>No posts yet üì≠</h5></div>
              {% endfor %}
          </div>
      </div>
  </div>

  {% if user.id == target_user.id %}
  
  <div class="modal fade" id="editProfileModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title fw-bold">Edit Profile</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <form action="/update_profile" method="post">
              <div class="mb-3"><label class="form-label fw-bold">Full Name</label><input type="text" name="name" class="form-control" value="{{ user.name }}" required></div>
              <div class="mb-3"><label class="form-label fw-bold">Bio</label><textarea name="bio" class="form-control" rows="3">{{ user.bio }}</textarea></div>
              <button type="submit" class="btn btn-primary w-100 rounded-pill">Save Changes</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="passwordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title fw-bold">Change Password</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <form action="/change_password" method="post">
              <div class="mb-3"><label class="form-label fw-bold">New Password</label><input type="password" name="new_password" class="form-control" required></div>
              <button type="submit" class="btn btn-danger w-100 rounded-pill">Update Password</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="interestModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title fw-bold">Select Your Interests</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <div class="interests-container">
                {% set all_interests = ["Watching Movies","Watching Anime","Playing Cricket","Playing Football","Playing Tennis","Gym & Fitness","Running / Jogging","Badminton","Cycling","Hiking / Trekking","Gaming","Reading Books","Writing","Music Listening","Singing / Instrument","Dancing","Photography","Art & Design","Cooking / Baking","Volunteering","Tech / Coding","AI & ML","Data Science","Startups","Finance & Investing","Philosophy","Meditation / Yoga","Debating","Movies Discussion","Carrom / Chess"] %}
                {% set selected_interests = user.interests.split(',')|map('trim')|list if user.interests else [] %}
                {% for interest in all_interests %}
                  <div class="interest-box {% if interest in selected_interests %}selected{% endif %}" data-interest="{{ interest }}">{{ interest }}</div>
                {% endfor %}
            </div>
            <button id="save-interests" class="btn btn-success w-100 rounded-pill fw-bold py-2">Save Interests</button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  {% if user.id == target_user.id %}
  <script>
    // Interest Selection Logic
    document.querySelectorAll('.interest-box').forEach(box => {
      box.addEventListener('click', () => box.classList.toggle('selected'));
    });

    document.getElementById('save-interests').addEventListener('click', () => {
      const selected = Array.from(document.querySelectorAll('.interest-box.selected')).map(box => box.dataset.interest);
      fetch('/update_interests', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({interests: selected}), credentials: 'same-origin'
      }).then(res => { if (res.ok) window.location.reload(); else alert("Failed to save."); });
    });
  </script>
  {% endif %}
</body>
</html>